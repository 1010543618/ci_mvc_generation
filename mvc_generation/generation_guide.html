<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>自动生成向导</title>
    <!-- Bootstrap -->
    <!-- <link href="<?php echo base_url('views/back/vendors/bootstrap/dist/css/bootstrap.min.css')?>" rel="stylesheet"> -->
    <link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <!-- <link href="<?php echo base_url('views/back/vendors/bootstrap/dist/css/font-awesome.min.css')?>" rel="stylesheet"> -->
    <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://cdn.bootcss.com/iCheck/1.0.2/skins/line/green.css" rel="stylesheet">
    <!-- Gentelella custom -->
    <link href="./external/custom.css" rel="stylesheet">
    <style>
      .row{
        margin: 0;
      }
      .padding-0{
        padding: 0;
      }
      #config-textarea{
        width: 100%;
        /*height: 500px;*/
      }
    </style>
  </head>
  <body class="nav-md">
    <div class="container body">
        <!-- page content -->
        <div class="row">
          <div class="col-md-12 col-sm-12 col-xs-12 padding-0">
            <div class="x_panel">
              <div class="x_title">
                <h2>自动生成向导<small>CI+Gentelella,写了一半的坑</small></h2>
                <div class="clearfix"></div>
              </div>
              <div class="x_content">
                <p>根据自己的环境进行配置.</p>
                <div id="wizard" class="form_wizard wizard_horizontal">
                  <ul class="wizard_steps">
                    <li>
                      <a href="#step-1">
                        <span class="step_no">1</span>
                        <span class="step_descr">
                          Step 1<br />
                            <small>配置数据库</small>
                        </span>
                      </a>
                    </li>
                    <li>
                      <a href="#step-2">
                        <span class="step_no">2</span>
                        <span class="step_descr">
                             Step 2<br />
                            <small>选择要自动生成的表</small>
                         </span>
                      </a>
                    </li>
                    <li>
                      <a href="#step-3">
                        <span class="step_no">3</span>
                        <span class="step_descr">
                            Step 3<br />
                            <small>选择生成位置</small>
                        </span>
                      </a>
                    </li>
                    <li>
                      <a href="#step-4">
                        <span class="step_no">4</span>
                        <span class="step_descr">
                            Step 4<br />
                            <small>修改配置文件</small>
                        </span>
                      </a>
                    </li>
                    <li>
                      <a href="#step-5">
                        <span class="step_no">5</span>
                        <span class="step_descr">
                            Step 5<br />
                            <small>自动生成</small>
                        </span>
                      </a>
                    </li>
                  </ul>
                  <div id="step-1">
                    <form id="step-1-form" class="form-horizontal form-label-left">
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">主&nbsp;&nbsp;&nbsp;机&nbsp;<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="host" type="text" value="localhost" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">用户名&nbsp;<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="user" type="text" value="root" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="middle-name" class="control-label col-md-3 col-sm-3 col-xs-12">密&nbsp;&nbsp;&nbsp;码&nbsp;<span class="required">*</span></label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="pwd" type="text" value="123456" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">数据库&nbsp;<span class="required">*</span></label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input name="db" type="text" value="test" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <input name="step" type="text" value="1" style="display: none;">
                    </form>
                  </div>
                  <div id="step-2">
                    <form id="step-2-form" class="form-horizontal form-label-left">
                      <div class="form-group">
                        <div class="col-md-offset-2 col-md-1">
                          <div class="checkbox">
                            <input id="select-all-tables" type="checkbox"> 
                            <label>
                              全选
                            </label>
                          </div>
                        </div>
                        <div id="tables-checkbox" class="col-md-6"></div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">主&nbsp;&nbsp;&nbsp;机&nbsp;<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="host" type="text" value="" readonly class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">用户名&nbsp;<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="user" type="text" value="" readonly class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="middle-name" class="control-label col-md-3 col-sm-3 col-xs-12">密&nbsp;&nbsp;&nbsp;码&nbsp;<span class="required">*</span></label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="pwd" type="text" value="" readonly class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">数据库&nbsp;<span class="required">*</span></label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input name="db" type="text" readonly class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <input name="step" type="text" value="2" style="display: none;">
                    </form>
                  </div>
                  <form id="step-3-4-form" action="" class="form-horizontal form-label-left">
                    <div id="step-3">
                      <h2 class="StepTitle text-center">选择生成位置</h2>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">model文件夹<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="m_folder" type="text" value="../application/models" class="form-control col-md-7 col-xs-12">
                        </div>
                        <label class="col-md-3 col-sm-3 col-xs-12 text-left text-danger" for="last-name">*会替换掉文件夹中的同名文件</label>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">view文件夹<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="v_folder" type="text" value="../views" class="form-control col-md-7 col-xs-12">
                        </div>
                        <label class="col-md-3 col-sm-3 col-xs-12 text-left text-danger" for="last-name">*会替换掉文件夹中的同名文件</label>
                      </div>
                      <div class="form-group">
                        <label for="middle-name" class="control-label col-md-3 col-sm-3 col-xs-12">controller文件夹<span class="required">*</span></label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="c_folder" type="text" value="../application/controllers" class="form-control col-md-7 col-xs-12">
                        </div>
                        <label class="col-md-3 col-sm-3 col-xs-12 text-left text-danger" for="last-name">*会替换掉文件夹中的同名文件</label>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">子view文件夹<span class="required">*</span></label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input name="v_child_folder" type="text" value="back" class="form-control col-md-7 col-xs-12">
                        </div>
                        <label class="col-md-3 col-sm-3 col-xs-12 text-left text-danger" for="last-name">*会替换掉文件夹中的同名文件</label>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">子controller文件夹<span class="required">*</span></label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input name="c_child_folder" type="text" value="back" class="form-control col-md-7 col-xs-12">
                        </div>
                        <label class="col-md-3 col-sm-3 col-xs-12 text-left text-danger" for="last-name">*会替换掉文件夹中的同名文件</label>
                      </div>
                      <input name="step" type="text" value="3_4" style="display: none;">
                    </div>
                    <div id="step-4">
                      <div class="col-md-offset-2 col-md-8">
                        <h2 class="StepTitle text-center">修改配置文件</h2>
                        <div class="col-md-6">
                          <div class="checkbox">
                            <input name="is_save_config" type="checkbox" value="true" checked="checked" id="is-save-generation-config">
                            <label>
                              是否将修改后的配置文件保存到./config
                            </label>
                          </div>
                          <textarea name="generation_config" id="config-textarea"></textarea>
                        </div>
                        <div class="col-md-6">
                          <ul>
                            <li>
                              <h1>【表名】(<*>map):</h1>
                              <ul>
                                <li>
                                  <h2>tbl_comment(<*>string):【表显示的名字】,</h2>
                                </li>
                                <li>
                                  <h2>id(<*>map，表主键（删除修改时用，默认自增长添加时不会显示）):</h2>
                                  <ul>
                                    <li>field(<*>string):【id的字段名】,</li>
                                    <li>comment(<*>string):【id显示的名字】,</li>
                                  </ul>
                                </li>
                                <li>
                                  <h2>col(list，表需要的列（添加查询用）):</h2>
                                  <ul>
                                    <li>
                                      <h3>(map，需要的每一列):</h3>
                                      <ul>
                                        <li>field(<*>string):【列的字段名】,</li>
                                        <li>comment(<*>string):【列显示的名字】,</li>
                                        <li>validation(string):【列的验证规则（parsley.js验证规则）】,</li>
                                        <li>type(string):【列的类型input(默认)/text/file/time/now】（input使用文本框，text将使用富文本编辑器，file将保存图片的位置，time将使用时间选择器）,</li>
                                        <li>file_path(string):【文件保存的路径，type为file时可设置】（不设置将保存到“跟目录/upload/当前表名”文件夹),</li>
                                      </ul>
                                    </li>
                                  </ul>
                                </li>
                                <li>
                                  <h2>join(map，外连接的表):</h2>
                                  <ul>
                                    <li>
                                      <h3>【表名】(map):</h3>
                                      <ul>
                                        <li>pri_field(<*>string):【左表字段名称（默认是主表的字段，如果是其他表的字段要使用表名.字段名）】,</li>
                                        <li>join_field(<*>string):【右表字段名称】,</li>
                                        <li>
                                          <h4>col(list，连接表要查询的列):</h4>
                                          <ul>
                                            <li>
                                              <h5>(map，连接表要查询的每一列):</h5>
                                              <ul>
                                                <li>field(<*>string):【列的字段名】,</li>
                                                <li>comment<*>string):【列显示的名字】,</li>
                                              </ul>
                                            </li>
                                          </ul>
                                        </li>
                                        <li>
                                          <h4>manipulation_col(list，连接要操作的列):</h4>
                                          <ul>
                                            <li>
                                              <h5>(map，连接的每一列):</h5>
                                              <ul>
                                                <li>field(<*>string):【列的字段名】,</li>
                                                <li>comment(<*>string):【列显示的名字】,</li>
                                                <li>formtype(string):【表单中选择的形式，select（默认）/multichoice/input（select将使用select单选，multichoice使用checkbox复选）】,</li>
                                                <li>option_field(string):【formtype为select或multichoice时显示的选项内容字段（默认是当前表的字段，如果是其他表的字段要使用表名.字段名）】,</li>
                                              </ul>
                                            </li>
                                          </ul>
                                        </li>
                                      </ul>
                                    </li>
                                  </ul>
                                </li>
                              </ul>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
                <!-- End SmartWizard Content -->
              </div>
            </div>
          </div>
        </div>
        <!-- /page content -->
    </div>

    <!-- jQuery -->
    <!-- <script src="<?php echo base_url('views/back/vendors/jquery/dist/jquery.min.js')?>"></script> -->
    <script src="http://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <!-- Bootstrap -->
    <!-- <script src="<?php echo base_url('views/back/vendors/bootstrap/dist/js/bootstrap.min.js')?>"></script> -->
    <script src="http://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- jQuery Smart Wizard -->
    <!-- <script src="<?php echo base_url('views/back/vendors/jQuery-Smart-Wizard/js/jquery.smartWizard.js')?>"></script> -->
    <script src="./external/jquery.smartWizard.js"></script>

    <script src="http://cdn.bootcss.com/iCheck/1.0.2/icheck.min.js"></script>
    <script>
      function init_SmartWizard() {
        if( typeof ($.fn.smartWizard) === 'undefined'){ return; }
        console.log('init_SmartWizard');
        $('#wizard').smartWizard({
          labelNext: '下一步',
          labelPrevious: '上一步',
          labelFinish: '完成',
          onLeaveStep: leaveStep,
        });
        $('.buttonNext').addClass('btn btn-success');
        $('.buttonPrevious').addClass('btn btn-primary');
        $('.buttonFinish').addClass('btn btn-default');
      };
      init_SmartWizard();

      function leaveStep(obj, context){
        console.log(obj, context);
        // 点击上一步
        if (context.fromStep > context.toStep) {
          return true;
        }
        // 点击下一步
        var isStepValid = false;
        switch(obj[0].rel){
          case '1':
            $.ajax({
              'type': 'GET',
              'async': false,
              'dataType': 'json',
              'data': $('#step-1-form').serialize(),
              'url': './ci_mvc_create.php'
            }).done(
              function(data,status){
                if(data['status'] == false){
                  alert(data['info']);
                }else{
                  if ($('#tables-checkbox').attr('is_add_checkbox') != 'true') {
                    $('#tables-checkbox').attr('is_add_checkbox', 'true')
                    $.each(data['info'], function(){
                      var div = '<div class="col-md-6"><div class="checkbox"><input name="tables[]" type="checkbox" value="'+this['tbl_name']+'"><label>'+this['tbl_name']+(this['tbl_comment'])+'</label></div></div>';
                      $('#tables-checkbox').append(div);
                    });
                    $('#tables-checkbox input').each(function(){
                      var self = $(this),
                          label = self.next(),
                          label_text = label.text();
                      label.remove();
                      self.iCheck({
                        checkboxClass: 'icheckbox_line-green',
                        insert: '<div class="icheck_line-icon"></div>' + label_text
                      });
                    });
                  }
                  
                  $("#step-2-form [name='host']").val($("#step-1-form [name='host']").val());
                  $("#step-2-form [name='user']").val($("#step-1-form [name='user']").val());
                  $("#step-2-form [name='pwd']").val($("#step-1-form [name='pwd']").val());
                  $("#step-2-form [name='db']").val($("#step-1-form [name='db']").val());
                  isStepValid = true;
                }
              }
            ).fail(function(){
              alert('无法连接到ci_mvc_create.php');
            });
            break;
          case '2':
            $.ajax({
              'type': 'GET',
              'async': false,
              'dataType': 'json',
              'data': $('#step-2-form').serialize(),
              'url': './ci_mvc_create.php'
            }).done(
              function(data,status){
                console.log(data,status);
                if(data['status'] == false){
                  alert(data['info']);
                }else{
                  $('#config-textarea').text(data['info']);
                  isStepValid = true;
                }
              }
            ).fail(function(){
              alert('无法连接到ci_mvc_create.php');
            });
            break;
          case '3':
            $.ajax({
              'type': 'GET',
              'async': false,
              'dataType': 'json',
              'data': $('#step-2-form').serialize(),
              'url': './ci_mvc_create.php'
            }).done(
              function(data,status){
                console.log(data,status);
                if(data['status'] == false){
                  alert(data['info']);
                }else{
                  $('#config-textarea').text(data['info']);
                  isStepValid = true;
                }
              }
            ).fail(function(){
              alert('无法连接到ci_mvc_create.php');
            });
            break;
          case '4':
            $.ajax({
              'type': 'GET',
              'async': false,
              'dataType': 'json',
              'data': $('#step-3-4-form').serialize(),
              'url': './ci_mvc_create.php'
            }).done(
              function(data,status){
                console.log(data,status);
                if(data['status'] == false){
                  alert(data['info']);
                }else{
                  $('#config-textarea').text(data['info']);
                  isStepValid = true;
                }
              }
            ).fail(function(){
              alert('无法连接到ci_mvc_create.php');
            });
            break;
        }
        return isStepValid;
      }

      function init_iCheck() {
        // 第二步的select-all-tables
        $('#select-all-tables').each(function(){
          var self = $(this),
              label = self.next(),
              label_text = label.text();
          label.remove();
          self.iCheck({
            checkboxClass: 'icheckbox_line-green',
            insert: '<div class="icheck_line-icon"></div>' + label_text
          }).on('ifChecked', function(){
            $('#tables-checkbox .icheckbox_line-green').addClass('checked');
            $('#tables-checkbox input').prop('checked', true);
          }).on('ifUnchecked', function(){
            $('#tables-checkbox .icheckbox_line-green').removeClass('checked');
            $('#tables-checkbox input').prop('checked', false)
          });
        });
        // 第三步的is-save-generation-config
        $('#is-save-generation-config').each(function(){
          var self = $(this),
              label = self.next(),
              label_text = label.text();
          label.remove();
          self.iCheck({
            checkboxClass: 'icheckbox_line-green',
            insert: '<div class="icheck_line-icon"></div>' + label_text
          });
        });
      }
      init_iCheck();
    </script>
  </body>
</html>